version: 1
applications:
  - appRoot: packages/my-shared-backend
    backend:
      phases:
        preBuild:
          commands:
            - echo "Setting Node.js version to 20..."
            - nvm use 20 || nvm install 20
            - node --version
            - npm --version
            - echo "Installing backend dependencies..."
            - npm ci
            - echo "Installing Amplify CLI locally..."
            - npm install @aws-amplify/backend-cli@latest --no-save
        build:
          commands:
            - echo "Deploying Amplify Gen 2 backend..."
            - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
        postBuild:
          commands:
            - echo "Generating backend outputs..."
            - npx ampx generate outputs --branch $AWS_BRANCH --app-id $AWS_APP_ID --out-dir ./
    frontend:
      phases:
        build:
          commands:
            - echo "Backend-only app - creating minimal frontend placeholder"
            - mkdir -p ./dist
            - echo "Backend API deployed successfully" > ./dist/index.html
      artifacts:
        baseDirectory: dist
        files:
          - '**/*'