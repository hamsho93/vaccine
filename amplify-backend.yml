version: 1
applications:
  - appRoot: packages/my-shared-backend
    backend:
      phases:
        preBuild:
          commands:
            - echo "Setting Node.js version to 20..."
            - nvm use 20 || nvm install 20
            - node --version
            - npm --version
            - echo "Installing backend dependencies..."
            - npm install --no-audit --no-fund --legacy-peer-deps
            - echo "Installing Amplify CLI locally..."
            - npm install @aws-amplify/backend-cli@latest --no-save --legacy-peer-deps
        build:
          commands:
            - echo "Deploying Amplify Gen 2 backend..."
            - npx ampx pipeline-deploy --branch $AWS_BRANCH --app-id $AWS_APP_ID
        postBuild:
          commands:
            - echo "Generating backend outputs..."
            - npx ampx generate outputs --branch $AWS_BRANCH --app-id $AWS_APP_ID --out-dir ./